name: Docker Build and Push main

on:
  push:
    branches:
      - Push-Review-To-Aggregator

env:
  WEBHOOK_URL: 'https://chat.googleapis.com/v1/spaces/AAQAzboGZ9I/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=mm7b6YU31Wg1VRAX5JYKrPCD-2FiDiKBupI7_yqCPow'

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        
      - name: Set build start time and generate tag
        id: setup
        run: |
          BUILD_START=$(date +%s)
          TAG=$(date +'%Y.%m.%d.%H%M')
          echo "BUILD_START_TIME=$BUILD_START" >> $GITHUB_ENV
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          echo "build_start_time=$BUILD_START" >> $GITHUB_OUTPUT
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT

      # Start notification
      - name: Notify Google Chat on build start
        env:
          WEBHOOK_URL: ${{ env.WEBHOOK_URL }}
        run: |
          PR_INFO=""
          if [[ "${{ github.event_name }}" == "pull_request" || "${{ github.event.head_commit.message }}" == *"Merge pull request"* ]]; then
            PR_NUMBER=$(echo "${{ github.event.head_commit.message }}" | grep -o '#[0-9]\+' | grep -o '[0-9]\+')
            if [ ! -z "$PR_NUMBER" ]; then
              PR_INFO="\nüìå PR: #${PR_NUMBER} (${{ github.server_url }}/${{ github.repository }}/pull/${PR_NUMBER})"
            fi
          fi
          COMMIT_INFO="\nüîó Commit: <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
          BRANCH_INFO="\nüåø Branch: ${{ github.ref_name }}"
          DOCKER_REPO="\nüì¶ Image Tag: roboost/talabat-service:${{ steps.setup.outputs.image_tag }}"
          ACTIONS_URL="\nüìã Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"text\": \"üöÄ Talabat Service Build Started \n\nüë§ Triggered by: ${{ github.actor }}${PR_INFO}${BRANCH_INFO}${COMMIT_INFO}${DOCKER_REPO}${ACTIONS_URL}\"}" \
          $WEBHOOK_URL

      - name: Debug Trigger Event
        run: |
          echo "Triggered by event: ${{ github.event_name }}"
          echo "Triggered by workflow: ${{ github.workflow }}"
          echo "Triggered by branch: ${{ github.ref_name }}"
          echo "Image tag: ${{ steps.setup.outputs.image_tag }}"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build Docker Image
        run: |
          docker build -t roboost/talabat-service:latest -f API/Dockerfile API/
          docker tag roboost/talabat-service:latest roboost/talabat-service:${{ steps.setup.outputs.image_tag }}
          docker push roboost/talabat-service:latest
          docker push roboost/talabat-service:${{ steps.setup.outputs.image_tag }}

      - name: Calculate build duration
        if: always()
        id: duration
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - ${{ steps.setup.outputs.build_start_time }}))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          BUILD_DURATION_STR="${MINUTES}m ${SECONDS}s"
          echo "BUILD_DURATION=$BUILD_DURATION_STR" >> $GITHUB_ENV
          echo "duration=$BUILD_DURATION_STR" >> $GITHUB_OUTPUT
      # Success notification
      - name: Notify Google Chat on build success
        if: success()
        env:
          WEBHOOK_URL: ${{ env.WEBHOOK_URL }}
        run: |
          PR_INFO=""
          if [[ "${{ github.event_name }}" == "pull_request" || "${{ github.event.head_commit.message }}" == *"Merge pull request"* ]]; then
            PR_NUMBER=$(echo "${{ github.event.head_commit.message }}" | grep -o '#[0-9]\+' | grep -o '[0-9]\+')
            if [ ! -z "$PR_NUMBER" ]; then
              PR_INFO="\nüìå PR: #${PR_NUMBER} (${{ github.server_url }}/${{ github.repository }}/pull/${PR_NUMBER})"
            fi
          fi
          COMMIT_INFO="\nüîó Commit: <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
          BRANCH_INFO="\nüåø Branch: ${{ github.ref_name }}"
          DOCKER_REPO="\nüì¶ Image Tag: roboost/talabat-service:${{ steps.setup.outputs.image_tag }}"
          BUILD_TIME="\n‚è±Ô∏è Duration: ${{ steps.duration.outputs.duration }}"
          ACTIONS_URL="\nüìã Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"text\": \"‚úÖ Talabat Service Build Success \n\nüë§ Built by: ${{ github.actor }}${PR_INFO}${BRANCH_INFO}${COMMIT_INFO}${DOCKER_REPO}${BUILD_TIME}${ACTIONS_URL}\"}" \
          $WEBHOOK_URL

      # Failure notification
      - name: Notify Google Chat on build Failure
        if: failure()
        env:
          WEBHOOK_URL: ${{ env.WEBHOOK_URL }}
        run: |
          # Get basic error information
          ERROR_INFO="\nüí• Build failed - Check the Actions log for detailed error information"

          PR_INFO=""
          if [[ "${{ github.event_name }}" == "pull_request" || "${{ github.event.head_commit.message }}" == *"Merge pull request"* ]]; then
            PR_NUMBER=$(echo "${{ github.event.head_commit.message }}" | grep -o '#[0-9]\+' | grep -o '[0-9]\+')
            if [ ! -z "$PR_NUMBER" ]; then
              PR_INFO="\nüìå PR: #${PR_NUMBER} (${{ github.server_url }}/${{ github.repository }}/pull/${PR_NUMBER})"
            fi
          fi
          COMMIT_INFO="\nüîó Commit: <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
          BRANCH_INFO="\nüåø Branch: ${{ github.ref_name }}"
          DOCKER_REPO="\nüì¶ Image Tag: roboost/talabat-service:${{ steps.setup.outputs.image_tag }}"
          BUILD_TIME="\n‚è±Ô∏è Duration: ${{ steps.duration.outputs.duration }}"
          ACTIONS_URL="\nüìã Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST -H "Content-Type: application/json" \
          -d "{\"text\": \"‚ùå Talabat Service Build Failed\n\nüë§ Triggered by: ${{ github.actor }}${PR_INFO}${BRANCH_INFO}${COMMIT_INFO}${DOCKER_REPO}${BUILD_TIME}${ACTIONS_URL}${ERROR_INFO}\"}" \
          $WEBHOOK_URL
